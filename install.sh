#!/usr/bin/env bash
set -e

if [ ! -d "lib/node_modules" ]; then
    mkdir lib/node_modules
    npm install pikaday@1.4.0 --prefix lib
    npm install jquery@2.1.4 --prefix lib
    npm install bootstrap@4.0.0-alpha.2 --prefix lib
fi

cd src/WebGui/
if [ ! -d "reflex-dom" ]; then
    git clone -b develop https://github.com/ryantrinkle/reflex-dom.git
    cd reflex-dom
    git reset --hard 4ce94d0afe35f5642e985800dd89fa457b324a07
    cd ..
    sed -i.bak -e "s/bifunctors == 4\.2\.\*/bifunctors >= 4\.2/g" reflex-dom/reflex-dom.cabal
fi

# install the ghcjs compiler
echo "will now install the GHCJS compiler, this should take a while..."
stack setup
echo "installed the GHCJS compiler!"

# happy needs GHC in the path to build.
# add the GHC we just set up to the path.
cd ../..
export PATH=$PATH:`stack path --bin-path`
cd src/WebGui/

stack install happy
export PATH=$PATH:~/.local/bin

echo "building the client-side app"
stack build
echo "built the client-side app"

# I have two projects, the executable cannot find the html/js
# generated by the cigale-web project. Copy the files so they'll
# be found.
htmljspath=$(stack path --local-install-root)
cd ../..

# install the ghc compiler
echo "will now install the ghc compiler, this may take a while..."
stack setup
echo "installed the GHC compiler!"

stack install
exepath=$(stack path --local-install-root)

# patch the RTS to workaround https://github.com/ghcjs/shims/pull/29
# (and this version of the patch there: https://github.com/ryantrinkle/shims/commit/18e4fc7a0217feee1275a74ed40f4a925263b9a3)
sed -i "s/work.push(c.d1);/work[w++] = c.d1;/" "$htmljspath/bin/cigale-web.jsexe/rts.js"
cp -R "$htmljspath/bin/cigale-web.jsexe" "$exepath/share"

# pikaday has a strange .c9 folders with a bad pikaday.css.
find lib/ -name "*.css" -not -path "*/.c9/*" -exec cp \{\} "$exepath/share/cigale-web.jsexe/" \;
cp -R lib/glyphicons_free/ "$exepath/share/cigale-web.jsexe/"

echo "built the app, copied the files, all set up and ready to go!"
