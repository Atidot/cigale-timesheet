<html>
<head>
	<title>
		Config
	</title>
	<script type='text/javascript' src='/static/jquery-1.8.3.min.js'></script>
	<style>
		div.arrayWrap {
			border: 1px solid;
		}
	</style>
</head>
<body>
	<script>
		function loadPluginAndConfigOpts() {
			$.getJSON('/configdesc', function(data) {
				$.each(data, function(index, pluginInfo) {
					handleConfigPluginInfo(pluginInfo);
				});
				$('#pluginAddCombo').change(function(e) {
					var pluginName = $(this).val();
					$.each(data, function(index, pluginInfo) {
						if (pluginInfo.pluginName === pluginName) {
							prepareAddPluginForm(pluginInfo);
						}
					});
				});
			});
		}

		function prepareAddPluginForm(pluginConfig) {
			$('div#optionValues').append("<h3>" +
				pluginConfig.pluginName + "</h3>");
			var datatypes = pluginConfig.pluginConfig;
			$.each(datatypes[0].members, function(index, configDataInfo) {
				var divtxt = getHtmlConfigDataInfoForm(configDataInfo, datatypes);
				$('div#optionValues').append(divtxt + '<br/>');
			});
		}

		function getHtmlProvidedType(providedTypes, typename) {
			var result = null;
			$.each(providedTypes, function(idx, val) {
				if (val.dataName === typename) {
					result = getHtmlProvidedTypeForm(val, providedTypes);
					return false;
				}
				if ('[' + val.dataName + ']' === typename) {
					// array of that type..
					result = getHtmlProvidedTypeForm(val, providedTypes);
					return false;
				}
			});
			if (result == null) {
				alert("failed to handle type " + typename);
			}
			return result;
		}

		function getHtmlProvidedTypeForm(configDataType, datatypes) {
			var result = "";
			$.each(configDataType.members, function(idx, configDataInfo) {
				var divtxt = getHtmlConfigDataInfoForm(configDataInfo, datatypes);
				result += divtxt + '<br/>';
			});
			return result;
		}

		function getHtmlConfigDataInfoForm(configDataInfo, datatypes) {
			if (configDataInfo.memberType.indexOf('[') == 0) {
				// array...
				return wrapInArray(configDataInfo.memberType.substring(1, configDataInfo.memberType.length-1),
					configDataInfo.memberName, datatypes);
			} else {
				switch (configDataInfo.memberType) {
				case "String":
				case "Text":
				case "ByteString":
					return addTextOption(configDataInfo.memberName);
				default:
					// ok we don't know the type,
					// but maybe it's described in
					// the config:
					return getHtmlProvidedType(datatypes, configDataInfo.memberType);
				}
			}
		}

		function addTextOption(memberTitle) {
			// TODO use the label tag for the description
			// but then i must generate a unique ID.
			return memberTitle + '<input type="text"/>';
		}

		function wrapInArray(memberTypeInArray, memberTitle, datatypes) {
			var divContents = getHtmlConfigDataInfoForm({'memberType': memberTypeInArray, 
				'memberName': memberTitle}, datatypes);
			return "<div class='arrayWrap'>" + divContents + '<+><br/></div>';
		}

		function handleConfigPluginInfo(pluginConfig) {
			$('#pluginAddCombo').append($('<option>', {
				value: pluginConfig.pluginName,
				text : pluginConfig.pluginName})
			);

		}

		$(document).ready(function() {
			loadPluginAndConfigOpts();
		});
	</script>
	Pick the plugin to add:
	<select id="pluginAddCombo"></select>
	<div id="optionValues"></div>
</body>
</html>

