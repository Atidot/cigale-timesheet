<html>
<head>
	<title>
		Config
	</title>
	<script type='text/javascript' src='/static/jquery-1.8.3.min.js'></script>
	<script type='text/javascript' src='/static/jquery-ui-1.9.2/js/jquery-ui-1.9.2.custom.min.js'></script>
	<link href="/static/jquery-ui-1.9.2/css/smoothness/jquery-ui-1.9.2.custom.css" rel="stylesheet">
	<style>
		div.arrayWrap {
			border: 1px solid;
		}
		div.configblock {
			background: aliceblue;
			margin: 5px;
		}
		.removeSpan {
			float: right;
		}
	</style>
</head>
<body>
	<script>
		function loadPluginAndConfigOpts() {
			window.pluginInfos = {};
			$("#pluginAddCombo").append('<option></option>');
			for (var pluginName in window.configSpec) {
				$('#pluginAddCombo').append($('<option>', {
					value: pluginName,
					text : pluginName})
				);
				window.pluginInfos[pluginName] = window.configSpec[pluginName];
			}
			$('#pluginAddCombo').change(function(e) {
				var pluginName = $(this).val();
				if (pluginName == "") {
					$('div#optionValues').empty();
				} else {
					prepareAddPluginForm(pluginName, window.pluginInfos[pluginName]);
				}
			});
		}

		function prepareAddPluginForm(pluginName, datatypes) {
			$('div#optionValues').empty();
			$('div#optionValues').append("<h3>" +
				pluginName + "</h3><table>");
			$.each(datatypes[0].members, function(index, configDataInfo) {
				var divtxt = getHtmlConfigDataInfoForm(pluginName,
					configDataInfo, datatypes, index);
				$('div#optionValues').append(divtxt + '</table>');
			});
			$('div#optionValues').append("<a href='#' id='addBtn'>Add</a>");
			$('a#addBtn').button().click(function(event) {
				var newPluginSettings = {};
				$.each(datatypes[0].members, function(index, configDataInfo) {
					newPluginSettings[configDataInfo['memberName']] = 
						getOptionValue(pluginName, configDataInfo, datatypes, index);
				});
				window.configByPlugin[pluginName].push(newPluginSettings);
				sendConfigToServer(window.configByPlugin);
				loadCurConfig();
				$('div#addPopup').dialog('close');
			});
		}

		function sendConfigToServer(jsonObj) {
			$.ajax({
				url: '/configUpdate',
				data: JSON.stringify(jsonObj),
				contentType: 'application/json',
				type: 'post'
			});
		}

		function getHtmlConfigDataInfoForm(pluginName, configDataInfo, datatypes, index) {
			if (configDataInfo.memberType.indexOf('[') == 0) {
				// array...
				alert("arrays not implemented yet! An old version was wiped from GIT on 2013-06-2");
			} else {
				switch (configDataInfo.memberType) {
				case "String":
				case "Text":
				case "ByteString":
					return addTextOption(configDataInfo.memberName, index);
				default:
					// ok we don't know the type,
					// but maybe it's described in
					// the config:
					return getHtmlProvidedType(pluginName, datatypes, configDataInfo.memberType);
				}
			}
		}

		function getOptionValue(pluginName, configDataInfo, datatypes, index) {
			switch (configDataInfo.memberType) {
				case "String":
				case "Text":
				case "ByteString":
					return $("input#text" + index).val();
				default:
					return null;

			}
		}

		function addTextOption(memberTitle, index) {
			// TODO use the label tag for the description
			// but then i must generate a unique ID.
			return '<tr><td>' + memberTitle + '</td><td><input type="text" id="text' + index + '"/></td></tr>';
		}

		function loadCurConfig() {
			$('div#curConfig').empty();
			var byPlugin = {};
			for (var pluginName in window.configByPlugin) {
				$('div#curConfig').append("<h3>" +
					pluginName + "</h3>");
				$.each(configByPlugin[pluginName], function(idx, config) {
					addPluginConfig(idx, config);
				});
			}
		}

		function addPluginConfig(idx, config) {
			var contents = "<table>";
			for (var member in config) {
				contents += "<tr><td>" + member + "</td><td>" + config[member] + "</td></tr>";
			}
			contents += "</table>";
			var removeBlock = '<span class="removeSpan" onclick="alert(\'TODO\')">[remove]</span>';
			$('div#curConfig').append("<div class='configblock'>" + removeBlock + contents + "</div>");
		}

		$(document).ready(function() {
			var dialogWidth=450;
			$('#addPopup').dialog({
				autoOpen: false,
				title: 'Add event provider',
				modal: true,
				width: dialogWidth,
				position: [($(window).width() / 2) - (dialogWidth / 2), 100]
			});
			$.when($.getJSON('/configVal'),
				$.getJSON('/configdesc'))
			.then(function(configByPluginResponse, configSpecResponse) {
				window.configSpec = configSpecResponse[0];
				window.configByPlugin = configByPluginResponse[0];
				loadCurConfig();
				loadPluginAndConfigOpts();
			});
			$('a#addEventButton')
				.button()
				.click(function(event) {
					$('#pluginAddCombo').val($("#pluginAddCombo option:first").val());
					$('div#optionValues').empty();
					$('#addPopup').dialog('open');
				});
		});
	</script>
	<a href="#" id="addEventButton">Add event provider...</a>
	<div id="addPopup">
		Pick the plugin to add:
		<select id="pluginAddCombo"></select>
		<div id="optionValues"></div>
	</div>
	<div id="curConfig"><div>
</body>
</html>

